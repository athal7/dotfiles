#!/bin/sh
# Set up Tailscale Drive to share specific directories
# Requires ACL config: drive:share and drive:access node attributes

# Check if tailscale is available
if ! command -v tailscale >/dev/null 2>&1; then
  echo "tailscale not installed, skipping drive setup"
  exit 0
fi

# Set operator to allow non-root tailscale commands
current_operator=$(tailscale debug prefs 2>/dev/null | grep -o '"OperatorUser":"[^"]*"' | cut -d'"' -f4)
if [ "$current_operator" != "{{ .chezmoi.username }}" ]; then
  echo "Setting tailscale operator to {{ .chezmoi.username }}..."
  sudo tailscale set --operator={{ .chezmoi.username }}
fi

# Shares to create (name:path)
SHARES="desktop:{{ .chezmoi.homeDir }}/Desktop documents:{{ .chezmoi.homeDir }}/Documents downloads:{{ .chezmoi.homeDir }}/Downloads"

for share in $SHARES; do
  name="${share%%:*}"
  path="${share#*:}"
  
  if tailscale drive list 2>/dev/null | grep -q "^${name}"; then
    echo "Tailscale drive '$name' already shared"
  elif tailscale drive share "$name" "$path" 2>&1; then
    echo "Shared $path as '$name' via Tailscale Drive"
  else
    echo "Could not share '$name' (ACLs may not be configured)"
  fi
done
