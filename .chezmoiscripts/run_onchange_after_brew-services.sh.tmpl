#!/bin/sh
{{ template "brewenv" . }}

# Brew services to start
SERVICES="opencode-pilot postgresql@16"

for svc in $SERVICES; do
  if brew list --formula 2>/dev/null | grep -q "^${svc}$"; then
    if ! brew services list | grep -q "^${svc}.*started"; then
      echo "Starting $svc service..."
      brew services start "$svc"
    else
      echo "$svc service already running"
    fi
  fi
done

# llama-server for fast local routing (Qwen3-4B via llama.cpp)
# Model auto-downloads on first run via -hf flag in the plist.
LLAMA_PLIST="$HOME/Library/LaunchAgents/com.{{ .chezmoi.username }}.llama-server.plist"
if brew list --formula 2>/dev/null | grep -q "^llama.cpp$"; then
  if [ -f "$LLAMA_PLIST" ]; then
    if ! launchctl list 2>/dev/null | grep -q "llama-server"; then
      echo "Starting llama-server..."
      launchctl load "$LLAMA_PLIST"
    else
      echo "llama-server already running"
    fi
  fi
fi
