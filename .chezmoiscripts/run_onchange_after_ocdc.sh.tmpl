#!/bin/bash
# Install ocdc plugin and skill after brew packages
# Checksum: {{ include ".chezmoitemplates/Brewfile" | sha256sum }}

{{ template "brewenv" . }}

# Only run if ocdc is installed
if command -v ocdc &> /dev/null; then
  echo "Setting up ocdc..."
  
  # Install OpenCode plugin
  ocdc plugin install
  
  # Symlink skill from Homebrew to opencode config
  SKILL_SRC="$(brew --prefix)/share/ocdc/skill/ocdc"
  SKILL_DST="$HOME/.config/opencode/skill/ocdc"
  
  if [[ -d "$SKILL_SRC" ]]; then
    mkdir -p "$HOME/.config/opencode/skill"
    rm -rf "$SKILL_DST"  # Remove existing (file or symlink)
    ln -s "$SKILL_SRC" "$SKILL_DST"
    echo "  Linked skill: $SKILL_DST -> $SKILL_SRC"
  fi
  
  # Add plugin to opencode config if not already there
  OPENCODE_CONFIG="$HOME/.config/opencode/opencode.json"
  PLUGIN_PATH="$HOME/.config/opencode/plugins/ocdc"
  
  if [[ -f "$OPENCODE_CONFIG" ]]; then
    # Check if plugin is already configured
    if ! grep -q "plugins/ocdc" "$OPENCODE_CONFIG" 2>/dev/null; then
      echo "  Note: Add \"$PLUGIN_PATH\" to plugin array in $OPENCODE_CONFIG"
    fi
  fi
  
  echo "ocdc setup complete!"
fi
