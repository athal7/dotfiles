#!/bin/bash
# Modify opencode.json by merging chezmoi-managed settings with existing config
# This preserves machine-specific settings (like MCP configs) while ensuring
# chezmoi-managed settings are always present.

set -euo pipefail

# Settings managed by chezmoi - these will always be applied
CHEZMOI_SETTINGS='
{
  "instructions": [
    "~/.config/opencode/AGENTS.local.md"
  ],
  "mcp": {
    "playwright": {
      "type": "local",
      "command": ["npx", "-y", "@playwright/mcp@latest"],
      "enabled": true
    },
    "figma": {
      "type": "local",
      "command": ["npx", "-y", "figma-developer-mcp", "--stdio"],
      "enabled": true
    }
  },
  "tools": {
    "playwright_*": false,
    "figma_*": false
  }
}
'

# Plugins to remove (deprecated or replaced)
PLUGINS_TO_REMOVE='["opencode-scheduler"]'

# Read existing config from stdin (chezmoi passes current file contents)
EXISTING=$(cat)

# If no existing config, start with empty object
if [ -z "$EXISTING" ] || [ "$EXISTING" = "{}" ]; then
  EXISTING='{}'
fi

# Merge: existing config + chezmoi settings (chezmoi settings win on conflict)
# Also remove deprecated plugins from the plugin array
echo "$EXISTING" | jq -s --argjson remove "$PLUGINS_TO_REMOVE" '
  .[0] * '"$CHEZMOI_SETTINGS"' |
  if .plugin then .plugin |= map(select(. as $p | $remove | index($p) | not)) else . end
'
